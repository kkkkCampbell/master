#!/bin/sh

PROGRAM=$(basename "$0")
SCRIPT_PATH=$0

case "$SCRIPT_PATH" in
*/*)
	SCRIPT_SOURCE=$(dirname "$SCRIPT_PATH")
	;;
*)
	LOOKUP=$(command -v -- "$SCRIPT_PATH" 2>/dev/null)
	if [ -n "$LOOKUP" ]; then
		SCRIPT_SOURCE=$(dirname "$LOOKUP")
	else
		SCRIPT_SOURCE='.'
	fi
	;;
esac

if ! SCRIPT_DIR=$(cd "$SCRIPT_SOURCE" 2>/dev/null && pwd); then
	printf '%s: unable to determine script directory\n' "$PROGRAM" >&2
	exit 1
fi
PROJECT_ROOT=$(dirname "$SCRIPT_DIR")
VERSION_FILE="${PROJECT_ROOT}/VERSION"
VERSION_FALLBACK='0.4.1'

if [ -r "$VERSION_FILE" ]; then
	VERSION=$(head -n 1 "$VERSION_FILE")
fi

if [ -z "$VERSION" ]; then
	VERSION=$VERSION_FALLBACK
fi

show_version() {
	printf '%s version %s\n' "$PROGRAM" "$VERSION"
}

for arg in "$@"; do
	case "$arg" in
	-V | --version)
		show_version
		exit 0
		;;
	esac
done

clear

printf '\n'
printf '===============================================\n'
printf 'opkg update\n'

# Получаем самое старое время установки
DISTRI_TIME=$(awk '/Installed-Time/ {print $2}' /usr/lib/opkg/status | sort -n | head -n 1)

# Генерируем список пакетов, разделяя на обычные и luci-i18n-
awk -v distri_time="$DISTRI_TIME" '
BEGIN { RS = ""; FS = "\n" }
{
    auto_installed = 0
    pkg_name = ""

    for (i = 1; i <= NF; i++) {
        if ($i ~ /^Package: /) {
            pkg_name = substr($i, 10)
        } else if ($i ~ /^Auto-Installed: yes/) {
            auto_installed = 1
        } else if ($i ~ "^Installed-Time: " distri_time "$") {
            auto_installed = 1
        }
    }

    if (pkg_name != "" && !auto_installed) {
        if (pkg_name ~ /luci-i18n-/) {
            print "2 " pkg_name
        } else {
            print "1 " pkg_name
        }
    }
}' /usr/lib/opkg/status | sort -k1,1n -k2 | cut -d' ' -f2- | while IFS= read -r pkg; do
	printf 'opkg install %s\n' "$pkg"
done

printf '===============================================\n'
